# hw definition file Matek L431 CAN node

# MCU class and specific type
MCU STM32H7xx STM32H743xx

# crystal frequency
OSCILLATOR_HZ 8000000

# board ID for firmware load
APJ_BOARD_ID 1063

FLASH_RESERVE_START_KB 128
FLASH_SIZE_KB 2048

# with 2M flash we can afford to optimize for speed
env OPTIMIZE -O2

# order of UARTs (and USB)
SERIAL_ORDER OTG1 UART4

# now we define the pins that USB is connected on
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

# these are the pins for SWD debugging with a STlinkv2 or black-magic probe
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

PA0 UART4_TX UART4
PA1 UART4_RX UART4

# SPI4 - sensors1
PE12 SPI4_SCK SPI4
PE13 SPI4_MISO SPI4
PE14 SPI4_MOSI SPI4

# SPI3 - sensors2
PB3 SPI3_SCK SPI3
PB4 SPI3_MISO SPI3
PB5 SPI3_MOSI SPI3

PA7  ICM42688_CS  CS
PB15 ICM20948_CS  CS
PA10 SPL06_CS  CS
PC14 FM25_CS  CS

# PWM AUX channels
PB0  TIM3_CH3 TIM3 PWM(1) GPIO(50)
PB1  TIM3_CH4 TIM3 PWM(2) GPIO(51)
PB10 TIM2_CH3 TIM2 PWM(3) GPIO(52)
PB11 TIM2_CH4 TIM2 PWM(4) GPIO(53)
PD12 TIM4_CH1 TIM4 PWM(5) GPIO(54)
PD13 TIM4_CH2 TIM4 PWM(6) GPIO(55)
PD14 TIM4_CH3 TIM4 PWM(7) GPIO(56)
PD15 TIM4_CH4 TIM4 PWM(8) GPIO(57)

# CAN bus
PB8 CAN1_RX CAN1
PB9 CAN1_TX CAN1

PB12 CAN2_RX CAN2
PB13 CAN2_TX CAN2

# SPI devices
SPIDEV icm20948 SPI3 DEVID1  ICM20948_CS MODE3  2*MHZ  8*MHZ
SPIDEV spl06    SPI3 DEVID2  SPL06_CS    MODE3  1*MHZ  1*MHZ
SPIDEV ramtron  SPI4 DEVID1  FM25_CS     MODE3  8*MHZ  8*MHZ
SPIDEV icm42688 SPI4 DEVID2  ICM42688_CS MODE3  2*MHZ  8*MHZ

# two IMU
IMU Invensensev3 SPI:icm42688 ROTATION_NONE
IMU Invensensev2 SPI:icm20948 ROTATION_YAW_270

# compass as part of ICM20948 on newer cubes
COMPASS AK09916:probe_ICM20948 0 ROTATION_ROLL_180_YAW_90

BARO SPL06 SPI:spl06

define HAL_DEFAULT_INS_FAST_SAMPLE 3

# microSD support
PC8 SDMMC1_D0 SDMMC1
PC9 SDMMC1_D1 SDMMC1
PC10 SDMMC1_D2 SDMMC1
PC11 SDMMC1_D3 SDMMC1
PC12 SDMMC1_CK SDMMC1
PD2 SDMMC1_CMD SDMMC1

# red LED marked as B/E
PC0 LED_R1 OUTPUT HIGH GPIO(0)
PC1 LED_G1 OUTPUT HIGH GPIO(1)
PC2 LED_B1 OUTPUT HIGH GPIO(2)

define HAL_GPIO_A_LED_PIN 0
define HAL_GPIO_B_LED_PIN 1
define HAL_GPIO_C_LED_PIN 2

define HAL_GPIO_LED_ON  0
define HAL_GPIO_LED_OFF 1

# use pixracer style 3-LED indicators
define HAL_HAVE_PIXRACER_LED

define HAL_USE_ADC FALSE
define STM32_ADC_USE_ADC1 FALSE
define HAL_DISABLE_ADC_DRIVER TRUE
define HAL_BATT_MONITOR_DEFAULT 8

define HAL_BATT_VOLT_PIN -1
define HAL_BATT_VOLT_SCALE -1
define HAL_BATT_CURR_PIN -1
define HAL_BATT_CURR_SCALE -1

# enable RAMTROM parameter storage
define HAL_STORAGE_SIZE 32768
define HAL_WITH_RAMTRON 1

# enable FAT filesystem support (needs a microSD defined via SDMMC)
define HAL_OS_FATFS_IO 1
